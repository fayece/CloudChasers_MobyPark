# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: [self-hosted, linux, x64, mobypark]
    container:
      image: mcr.microsoft.com/dotnet/sdk:8.0
    env:
      DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
      DOTNET_ROOT: ${{ github.workspace }}/.dotnet

    steps:
    - uses: actions/checkout@v4
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore
    - name: Test
      run: dotnet test --no-build --verbosity normal
  
  metrics:
    name: Metrics - job durations
    runs-on: ubuntu-latest
    needs: [ build ]
    if: always()
    permissions:
      actions: read
      contents: read
    steps:
      - name: Fetch jobs and compute durations
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          
          jobs_json="$(curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/jobs?per_page=100")"
          
          echo "$jobs_json" | jq -r '
            .jobs[]
            | select(.started_at != null and .completed_at != null)
            | [
                .name,
                .conclusion,
                .started_at,
                .completed_at
              ] | @tsv
          ' | while IFS=$'\t' read -r name conclusion started completed; do
              start_epoch=$(date -d "$started" +%s)
              end_epoch=$(date -d "$completed" +%s)
              duration=$((end_epoch - start_epoch))
          
              echo "job=$name conclusion=$conclusion duration_seconds=$duration started=$started completed=$completed"
          
              done

    
    
    
